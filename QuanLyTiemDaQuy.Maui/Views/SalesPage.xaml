<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:QuanLyTiemDaQuy.Maui.Converters"
             x:Class="QuanLyTiemDaQuy.Maui.Views.SalesPage"
             x:Name="SalesPageRoot"
             Title="BÃ¡n hÃ ng">

    <!-- Responsive: Phone = Vertical, Tablet/POS = Horizontal -->
    <ContentPage.Resources>
        <converters:ProductImageConverter x:Key="ProductImageConverter"/>
        <Style x:Key="ProductCardStyle" TargetType="Frame">
            <Setter Property="Padding" Value="8"/>
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="BackgroundColor" Value="White"/>
            <Setter Property="HasShadow" Value="True"/>
        </Style>
    </ContentPage.Resources>

    <Grid x:Name="MainGrid" RowDefinitions="Auto,*">
        
        <!-- Header with Search -->
        <Grid Grid.Row="0" Padding="12" BackgroundColor="{StaticResource Primary}">
            <Grid ColumnDefinitions="*,Auto">
                <SearchBar Grid.Column="0"
                           Placeholder="TÃ¬m kiáº¿m sáº£n pháº©m..."
                           Text="{Binding SearchText}"
                           SearchCommand="{Binding SearchProductCommand}"
                           BackgroundColor="White"
                           PlaceholderColor="{StaticResource Gray400}"/>
                <Button Grid.Column="1"
                        Text="ðŸ”„"
                        Command="{Binding RefreshCommand}"
                        BackgroundColor="White"
                        TextColor="{StaticResource Primary}"
                        WidthRequest="50"
                        Margin="8,0,0,0"/>
            </Grid>
        </Grid>

        <!-- PHONE LAYOUT (Portrait - Vertical Stack) -->
        <ScrollView Grid.Row="1" x:Name="PhoneLayout">
            <VisualStateManager.VisualStateGroups>
                <VisualStateGroup x:Name="LayoutStates">
                    <VisualState x:Name="Phone">
                        <VisualState.StateTriggers>
                            <AdaptiveTrigger MinWindowWidth="0"/>
                        </VisualState.StateTriggers>
                        <VisualState.Setters>
                            <Setter Property="IsVisible" Value="True"/>
                        </VisualState.Setters>
                    </VisualState>
                    <VisualState x:Name="Tablet">
                        <VisualState.StateTriggers>
                            <AdaptiveTrigger MinWindowWidth="800"/>
                        </VisualState.StateTriggers>
                        <VisualState.Setters>
                            <Setter Property="IsVisible" Value="False"/>
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateManager.VisualStateGroups>
            
            <VerticalStackLayout Spacing="12" Padding="12">
                
                <!-- PRODUCTS SECTION -->
                <Label Text="ðŸ’Ž Sáº£n pháº©m" 
                       Style="{StaticResource Subtitle}"
                       FontSize="18"/>
                
                <CollectionView ItemsSource="{Binding AvailableProducts}"
                                SelectionMode="None"
                                HeightRequest="380">
                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Orientation="Vertical" 
                                         Span="2" 
                                         HorizontalItemSpacing="8"
                                         VerticalItemSpacing="8"/>
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame Style="{StaticResource ProductCardStyle}" HeightRequest="150">
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer 
                                        Command="{Binding Source={x:Reference SalesPageRoot}, Path=BindingContext.AddToCartCommand}"
                                        CommandParameter="{Binding .}"/>
                                </Frame.GestureRecognizers>
                                <Grid RowDefinitions="50,*" RowSpacing="4">
                                    <Frame Grid.Row="0" Padding="0" CornerRadius="8" 
                                           BackgroundColor="{StaticResource Gray100}" HasShadow="False" IsClippedToBounds="True">
                                        <Label Text="{Binding Name, Converter={StaticResource ProductImageConverter}}"
                                               FontSize="32" HorizontalOptions="Center" VerticalOptions="Center"/>
                                    </Frame>
                                    <VerticalStackLayout Grid.Row="1" Spacing="2">
                                        <Label Text="{Binding ProductCode}" FontSize="9" TextColor="{StaticResource Gray500}"/>
                                        <Label Text="{Binding Name}" FontAttributes="Bold" FontSize="11" LineBreakMode="TailTruncation" MaxLines="2"/>
                                        <Label Text="{Binding SellPrice, StringFormat='{0:N0} â‚«'}" TextColor="{StaticResource Primary}" FontAttributes="Bold" FontSize="12"/>
                                        <Label Text="{Binding StockQty, StringFormat='Kho: {0}'}" FontSize="9" TextColor="{StaticResource Success}"/>
                                    </VerticalStackLayout>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                    <CollectionView.EmptyView>
                        <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Padding="32">
                            <Label Text="ðŸ“¦" FontSize="48" HorizontalTextAlignment="Center"/>
                            <Label Text="KhÃ´ng cÃ³ sáº£n pháº©m" HorizontalTextAlignment="Center"/>
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>
                </CollectionView>

                <!-- CART SECTION -->
                <Frame Padding="12" Style="{StaticResource Card}">
                    <VerticalStackLayout Spacing="8">
                        <Label Text="ðŸ›’ Giá» hÃ ng" Style="{StaticResource Subtitle}" FontSize="18"/>
                        
                        <!-- Customer Selection -->
                        <Frame Padding="8" BorderColor="{StaticResource Gray200}">
                            <Picker ItemsSource="{Binding CustomerList}"
                                    ItemDisplayBinding="{Binding Name}"
                                    SelectedItem="{Binding SelectedCustomer}"
                                    Title="Chá»n khÃ¡ch hÃ ng"
                                    TextColor="Black"
                                    TitleColor="{StaticResource Gray500}"
                                    BackgroundColor="Transparent"/>
                        </Frame>
                        
                        <!-- Cart Items -->
                        <CollectionView ItemsSource="{Binding CartItems}" HeightRequest="120">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Frame Margin="0,2" Padding="8" BorderColor="{StaticResource Gray200}">
                                        <Grid ColumnDefinitions="*,Auto,Auto">
                                            <VerticalStackLayout>
                                                <Label Text="{Binding ProductName}" FontAttributes="Bold" FontSize="12" LineBreakMode="TailTruncation"/>
                                                <Label Text="{Binding UnitPrice, StringFormat='{0:N0} â‚«'}" FontSize="10" TextColor="{StaticResource Gray500}"/>
                                            </VerticalStackLayout>
                                            <HorizontalStackLayout Grid.Column="1" Spacing="2">
                                                <Button Text="-" WidthRequest="28" HeightRequest="28" Padding="0"
                                                        BackgroundColor="{StaticResource Gray200}" TextColor="{StaticResource Gray600}"
                                                        Command="{Binding Source={x:Reference SalesPageRoot}, Path=BindingContext.DecreaseQtyCommand}"
                                                        CommandParameter="{Binding .}"/>
                                                <Label Text="{Binding Qty}" VerticalTextAlignment="Center" WidthRequest="24" HorizontalTextAlignment="Center"/>
                                                <Button Text="+" WidthRequest="28" HeightRequest="28" Padding="0"
                                                        BackgroundColor="{StaticResource Primary}" TextColor="White"
                                                        Command="{Binding Source={x:Reference SalesPageRoot}, Path=BindingContext.IncreaseQtyCommand}"
                                                        CommandParameter="{Binding .}"/>
                                            </HorizontalStackLayout>
                                            <Label Grid.Column="2" Text="{Binding LineTotal, StringFormat='{0:N0}'}"
                                                   VerticalTextAlignment="Center" FontAttributes="Bold" WidthRequest="70" HorizontalTextAlignment="End"/>
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                            <CollectionView.EmptyView>
                                <Label Text="Giá» hÃ ng trá»‘ng - Cháº¡m sáº£n pháº©m Ä‘á»ƒ thÃªm" 
                                       TextColor="{StaticResource Gray400}" HorizontalTextAlignment="Center" Padding="16"/>
                            </CollectionView.EmptyView>
                        </CollectionView>
                        
                        <!-- Totals -->
                        <VerticalStackLayout Spacing="2">
                            <BoxView HeightRequest="1" Color="{StaticResource Gray200}"/>
                            <Grid ColumnDefinitions="*,*">
                                <Label Text="Táº¡m tÃ­nh:" FontSize="12" TextColor="{StaticResource Gray600}"/>
                                <Label Grid.Column="1" Text="{Binding Subtotal, StringFormat='{0:N0} â‚«'}" HorizontalTextAlignment="End" FontSize="12"/>
                            </Grid>
                            <Grid ColumnDefinitions="*,*">
                                <Label Text="Giáº£m giÃ¡:" FontSize="12" TextColor="{StaticResource Gray600}"/>
                                <Label Grid.Column="1" Text="{Binding Discount, StringFormat='-{0:N0} â‚«'}" HorizontalTextAlignment="End" TextColor="{StaticResource Error}" FontSize="12"/>
                            </Grid>
                            <Grid ColumnDefinitions="*,*">
                                <Label Text="VAT (10%):" FontSize="12" TextColor="{StaticResource Gray600}"/>
                                <Label Grid.Column="1" Text="{Binding VATAmount, StringFormat='{0:N0} â‚«'}" HorizontalTextAlignment="End" FontSize="12"/>
                            </Grid>
                            <BoxView HeightRequest="1" Color="{StaticResource Gray300}"/>
                            <Grid ColumnDefinitions="*,*" Padding="0,4">
                                <Label Text="Tá»•ng cá»™ng:" FontAttributes="Bold" FontSize="16"/>
                                <Label Grid.Column="1" Text="{Binding Total, StringFormat='{0:N0} â‚«'}"
                                       HorizontalTextAlignment="End" FontAttributes="Bold" FontSize="18" TextColor="{StaticResource Primary}"/>
                            </Grid>
                        </VerticalStackLayout>
                        
                        <!-- Action Buttons -->
                        <Grid ColumnDefinitions="*,*,*" ColumnSpacing="4">
                            <Button Text="â³ LÆ°u" Command="{Binding SavePendingCommand}" BackgroundColor="#FFC107" TextColor="Black" FontSize="10"/>
                            <Button Grid.Column="1" Text="ðŸ“‹ Láº¥y HÄ" Command="{Binding RetrievePendingCommand}" BackgroundColor="#17A2B8" TextColor="White" FontSize="10"/>
                            <Button Grid.Column="2" Text="ðŸš« Huá»·" Command="{Binding CancelPendingCommand}" BackgroundColor="#DC3545" TextColor="White" FontSize="10"/>
                        </Grid>
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                            <Button Text="ðŸ—‘ï¸ XÃ³a giá»" Command="{Binding ClearCartCommand}" Style="{StaticResource SecondaryButton}"/>
                            <Button Grid.Column="1" Text="ðŸ’³ Thanh toÃ¡n" Command="{Binding CheckoutCommand}" Style="{StaticResource PrimaryButton}"/>
                        </Grid>
                    </VerticalStackLayout>
                </Frame>
            </VerticalStackLayout>
        </ScrollView>

        <!-- TABLET/POS LAYOUT (Landscape - Horizontal Split) -->
        <Grid Grid.Row="1" x:Name="TabletLayout" ColumnDefinitions="3*,2*" ColumnSpacing="12" Padding="12" IsVisible="False">
            <VisualStateManager.VisualStateGroups>
                <VisualStateGroup x:Name="LayoutStatesTablet">
                    <VisualState x:Name="PhoneHide">
                        <VisualState.StateTriggers>
                            <AdaptiveTrigger MinWindowWidth="0"/>
                        </VisualState.StateTriggers>
                        <VisualState.Setters>
                            <Setter Property="IsVisible" Value="False"/>
                        </VisualState.Setters>
                    </VisualState>
                    <VisualState x:Name="TabletShow">
                        <VisualState.StateTriggers>
                            <AdaptiveTrigger MinWindowWidth="800"/>
                        </VisualState.StateTriggers>
                        <VisualState.Setters>
                            <Setter Property="IsVisible" Value="True"/>
                        </VisualState.Setters>
                    </VisualState>
                </VisualStateGroup>
            </VisualStateManager.VisualStateGroups>
            
            <!-- LEFT: Products Grid -->
            <ScrollView Grid.Column="0">
                <VerticalStackLayout Spacing="8">
                    <Label Text="ðŸ’Ž Sáº£n pháº©m cÃ³ sáºµn" Style="{StaticResource Subtitle}" FontSize="20"/>
                    
                    <CollectionView ItemsSource="{Binding AvailableProducts}" SelectionMode="None">
                        <CollectionView.ItemsLayout>
                            <GridItemsLayout Orientation="Vertical" Span="3" HorizontalItemSpacing="10" VerticalItemSpacing="10"/>
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame Style="{StaticResource ProductCardStyle}" Padding="12" HeightRequest="180">
                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer 
                                            Command="{Binding Source={x:Reference SalesPageRoot}, Path=BindingContext.AddToCartCommand}"
                                            CommandParameter="{Binding .}"/>
                                    </Frame.GestureRecognizers>
                                    <Grid RowDefinitions="70,*" RowSpacing="8">
                                        <Frame Grid.Row="0" Padding="0" CornerRadius="10" 
                                               BackgroundColor="{StaticResource Gray100}" HasShadow="False" IsClippedToBounds="True">
                                            <Label Text="{Binding Name, Converter={StaticResource ProductImageConverter}}"
                                                   FontSize="40" HorizontalOptions="Center" VerticalOptions="Center"/>
                                        </Frame>
                                        <VerticalStackLayout Grid.Row="1" Spacing="4">
                                            <Label Text="{Binding ProductCode}" FontSize="10" TextColor="{StaticResource Gray500}"/>
                                            <Label Text="{Binding Name}" FontAttributes="Bold" FontSize="13" LineBreakMode="TailTruncation" MaxLines="2"/>
                                            <Label Text="{Binding SellPrice, StringFormat='{0:N0} â‚«'}" TextColor="{StaticResource Primary}" FontAttributes="Bold" FontSize="14"/>
                                            <Label Text="{Binding StockQty, StringFormat='Tá»“n kho: {0}'}" FontSize="11" TextColor="{StaticResource Success}"/>
                                        </VerticalStackLayout>
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                        <CollectionView.EmptyView>
                            <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Padding="40">
                                <Label Text="ðŸ“¦" FontSize="64" HorizontalTextAlignment="Center"/>
                                <Label Text="KhÃ´ng cÃ³ sáº£n pháº©m" FontSize="16" HorizontalTextAlignment="Center"/>
                            </VerticalStackLayout>
                        </CollectionView.EmptyView>
                    </CollectionView>
                </VerticalStackLayout>
            </ScrollView>
            
            <!-- RIGHT: Cart Panel -->
            <Frame Grid.Column="1" Style="{StaticResource Card}" Padding="16">
                <Grid RowDefinitions="Auto,*,Auto,Auto">
                    
                    <!-- Cart Header -->
                    <VerticalStackLayout Grid.Row="0" Spacing="12">
                        <Label Text="ðŸ›’ Giá» hÃ ng" Style="{StaticResource Subtitle}" FontSize="22"/>
                        <Frame Padding="10" BorderColor="{StaticResource Gray200}">
                            <Grid ColumnDefinitions="*,Auto">
                                <Picker ItemsSource="{Binding CustomerList}" ItemDisplayBinding="{Binding Name}"
                                        SelectedItem="{Binding SelectedCustomer}" Title="Chá»n khÃ¡ch hÃ ng"/>
                                <Button Grid.Column="1" Text="ðŸ‘¤" BackgroundColor="Transparent" TextColor="{StaticResource Primary}"/>
                            </Grid>
                        </Frame>
                    </VerticalStackLayout>
                    
                    <!-- Cart Items -->
                    <CollectionView Grid.Row="1" ItemsSource="{Binding CartItems}" Margin="0,12">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <SwipeView>
                                    <SwipeView.RightItems>
                                        <SwipeItems>
                                            <SwipeItem Text="XÃ³a" BackgroundColor="{StaticResource Error}"
                                                       Command="{Binding Source={x:Reference SalesPageRoot}, Path=BindingContext.RemoveFromCartCommand}"
                                                       CommandParameter="{Binding .}"/>
                                        </SwipeItems>
                                    </SwipeView.RightItems>
                                    <Frame Margin="0,4" Padding="10" BorderColor="{StaticResource Gray200}">
                                        <Grid ColumnDefinitions="*,Auto,Auto">
                                            <VerticalStackLayout>
                                                <Label Text="{Binding ProductName}" FontAttributes="Bold" FontSize="14" LineBreakMode="TailTruncation"/>
                                                <Label Text="{Binding UnitPrice, StringFormat='{0:N0} â‚«'}" FontSize="12" TextColor="{StaticResource Gray500}"/>
                                            </VerticalStackLayout>
                                            <HorizontalStackLayout Grid.Column="1" Spacing="4">
                                                <Button Text="-" WidthRequest="36" HeightRequest="36" Padding="0"
                                                        BackgroundColor="{StaticResource Gray200}" TextColor="{StaticResource Gray600}"
                                                        Command="{Binding Source={x:Reference SalesPageRoot}, Path=BindingContext.DecreaseQtyCommand}"
                                                        CommandParameter="{Binding .}"/>
                                                <Label Text="{Binding Qty}" VerticalTextAlignment="Center" WidthRequest="32" HorizontalTextAlignment="Center" FontSize="14"/>
                                                <Button Text="+" WidthRequest="36" HeightRequest="36" Padding="0"
                                                        BackgroundColor="{StaticResource Primary}" TextColor="White"
                                                        Command="{Binding Source={x:Reference SalesPageRoot}, Path=BindingContext.IncreaseQtyCommand}"
                                                        CommandParameter="{Binding .}"/>
                                            </HorizontalStackLayout>
                                            <Label Grid.Column="2" Text="{Binding LineTotal, StringFormat='{0:N0}'}"
                                                   VerticalTextAlignment="Center" FontAttributes="Bold" WidthRequest="90" FontSize="14" HorizontalTextAlignment="End"/>
                                        </Grid>
                                    </Frame>
                                </SwipeView>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                        <CollectionView.EmptyView>
                            <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center">
                                <Label Text="Giá» hÃ ng trá»‘ng" TextColor="{StaticResource Gray400}" FontSize="16" HorizontalTextAlignment="Center"/>
                                <Label Text="Cháº¡m vÃ o sáº£n pháº©m Ä‘á»ƒ thÃªm" FontSize="13" TextColor="{StaticResource Gray400}" HorizontalTextAlignment="Center"/>
                            </VerticalStackLayout>
                        </CollectionView.EmptyView>
                    </CollectionView>
                    
                    <!-- Totals -->
                    <VerticalStackLayout Grid.Row="2" Spacing="6" Padding="0,8">
                        <BoxView HeightRequest="1" Color="{StaticResource Gray200}"/>
                        <Grid ColumnDefinitions="*,*"><Label Text="Táº¡m tÃ­nh:" TextColor="{StaticResource Gray600}"/><Label Grid.Column="1" Text="{Binding Subtotal, StringFormat='{0:N0} â‚«'}" HorizontalTextAlignment="End"/></Grid>
                        <Grid ColumnDefinitions="*,*"><Label Text="Giáº£m giÃ¡:" TextColor="{StaticResource Gray600}"/><Label Grid.Column="1" Text="{Binding Discount, StringFormat='-{0:N0} â‚«'}" HorizontalTextAlignment="End" TextColor="{StaticResource Error}"/></Grid>
                        <Grid ColumnDefinitions="*,*"><Label Text="VAT (10%):" TextColor="{StaticResource Gray600}"/><Label Grid.Column="1" Text="{Binding VATAmount, StringFormat='{0:N0} â‚«'}" HorizontalTextAlignment="End"/></Grid>
                        <BoxView HeightRequest="2" Color="{StaticResource Gray300}"/>
                        <Grid ColumnDefinitions="*,*" Padding="0,6">
                            <Label Text="Tá»”NG Cá»˜NG:" FontAttributes="Bold" FontSize="18"/>
                            <Label Grid.Column="1" Text="{Binding Total, StringFormat='{0:N0} â‚«'}" HorizontalTextAlignment="End" FontAttributes="Bold" FontSize="22" TextColor="{StaticResource Primary}"/>
                        </Grid>
                    </VerticalStackLayout>
                    
                    <!-- Action Buttons -->
                    <VerticalStackLayout Grid.Row="3" Spacing="8">
                        <Grid ColumnDefinitions="*,*,*" ColumnSpacing="6">
                            <Button Text="â³ LÆ°u chá»" Command="{Binding SavePendingCommand}" BackgroundColor="#FFC107" TextColor="Black" FontSize="12"/>
                            <Button Grid.Column="1" Text="ðŸ“‹ Láº¥y HÄ" Command="{Binding RetrievePendingCommand}" BackgroundColor="#17A2B8" TextColor="White" FontSize="12"/>
                            <Button Grid.Column="2" Text="ðŸš« Huá»· HÄ" Command="{Binding CancelPendingCommand}" BackgroundColor="#DC3545" TextColor="White" FontSize="12"/>
                        </Grid>
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                            <Button Text="ðŸ—‘ï¸ Há»§y giá» hÃ ng" Command="{Binding ClearCartCommand}" Style="{StaticResource SecondaryButton}" FontSize="14"/>
                            <Button Grid.Column="1" Text="ðŸ’³ THANH TOÃN" Command="{Binding CheckoutCommand}" Style="{StaticResource PrimaryButton}" FontSize="16" FontAttributes="Bold"/>
                        </Grid>
                    </VerticalStackLayout>
                </Grid>
            </Frame>
        </Grid>
        
        <!-- Loading Overlay -->
        <Grid Grid.RowSpan="2" IsVisible="{Binding IsLoading}" BackgroundColor="#80000000">
            <ActivityIndicator IsRunning="True" Color="White" HorizontalOptions="Center" VerticalOptions="Center"/>
        </Grid>
    </Grid>

</ContentPage>
