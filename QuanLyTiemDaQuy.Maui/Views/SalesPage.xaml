<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="QuanLyTiemDaQuy.Maui.Views.SalesPage"
             Title="BÃ¡n hÃ ng">

    <Grid RowDefinitions="Auto,*,Auto" ColumnDefinitions="2*,*">
        
        <!-- Header with Search -->
        <Grid Grid.Row="0" Grid.ColumnSpan="2" 
              Padding="16" BackgroundColor="{StaticResource Primary}">
            <Grid ColumnDefinitions="*,Auto">
                <SearchBar Grid.Column="0"
                           Placeholder="TÃ¬m sáº£n pháº©m theo mÃ£ hoáº·c tÃªn..."
                           Text="{Binding SearchText}"
                           SearchCommand="{Binding SearchProductCommand}"
                           BackgroundColor="White"
                           PlaceholderColor="{StaticResource Gray400}"/>
                <Button Grid.Column="1"
                        Text="ðŸ”„"
                        Command="{Binding RefreshCommand}"
                        BackgroundColor="White"
                        TextColor="{StaticResource Primary}"
                        WidthRequest="50"
                        Margin="8,0,0,0"/>
            </Grid>
        </Grid>

        <!-- Left Panel: Product Grid -->
        <ScrollView Grid.Row="1" Grid.Column="0" Padding="8">
            <VerticalStackLayout Spacing="8">
                <Label Text="Sáº£n pháº©m cÃ³ sáºµn" 
                       Style="{StaticResource Subtitle}"
                       Margin="8,0"/>
                
                <CollectionView ItemsSource="{Binding AvailableProducts}"
                                SelectionMode="None">
                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Orientation="Vertical" 
                                         Span="2" 
                                         HorizontalItemSpacing="8"
                                         VerticalItemSpacing="8"/>
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame Padding="12" Style="{StaticResource Card}">
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer 
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.AddToCartCommand}"
                                        CommandParameter="{Binding .}"/>
                                </Frame.GestureRecognizers>
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="{Binding ProductCode}" 
                                           FontSize="11"
                                           TextColor="{StaticResource Gray500}"/>
                                    <Label Text="{Binding Name}" 
                                           FontAttributes="Bold"
                                           LineBreakMode="TailTruncation"
                                           MaxLines="2"/>
                                    <Label Text="{Binding SellPrice, StringFormat='{0:N0} â‚«'}"
                                           TextColor="{StaticResource Primary}"
                                           FontAttributes="Bold"/>
                                    <HorizontalStackLayout Spacing="4">
                                        <Label Text="Tá»“n kho:" 
                                               FontSize="11"
                                               TextColor="{StaticResource Gray500}"/>
                                        <Label Text="{Binding StockQty}" 
                                               FontSize="11"
                                               TextColor="{StaticResource Success}"/>
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                    
                    <CollectionView.EmptyView>
                        <VerticalStackLayout VerticalOptions="Center" 
                                             HorizontalOptions="Center"
                                             Padding="32">
                            <Label Text="ðŸ“¦" FontSize="48" HorizontalTextAlignment="Center"/>
                            <Label Text="KhÃ´ng cÃ³ sáº£n pháº©m" HorizontalTextAlignment="Center"/>
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>
                </CollectionView>
            </VerticalStackLayout>
        </ScrollView>

        <!-- Right Panel: Cart -->
        <Frame Grid.Row="1" Grid.Column="1" 
               Margin="8" Padding="12" 
               Style="{StaticResource Card}">
            <Grid RowDefinitions="Auto,*,Auto,Auto,Auto">
                
                <!-- Cart Header -->
                <VerticalStackLayout Grid.Row="0" Spacing="8">
                    <Label Text="ðŸ›’ Giá» hÃ ng" 
                           Style="{StaticResource Subtitle}"/>
                    
                    <!-- Customer Selection -->
                    <Frame Padding="8" BorderColor="{StaticResource Gray200}">
                        <Grid ColumnDefinitions="*,Auto">
                            <Picker ItemsSource="{Binding CustomerList}"
                                    ItemDisplayBinding="{Binding Name}"
                                    SelectedItem="{Binding SelectedCustomer}"
                                    Title="Chá»n khÃ¡ch hÃ ng"/>
                            <Button Grid.Column="1" 
                                    Text="ðŸ‘¤" 
                                    BackgroundColor="Transparent"
                                    TextColor="{StaticResource Primary}"/>
                        </Grid>
                    </Frame>
                </VerticalStackLayout>
                
                <!-- Cart Items -->
                <CollectionView Grid.Row="1" 
                                ItemsSource="{Binding CartItems}"
                                Margin="0,8">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <SwipeView>
                                <SwipeView.RightItems>
                                    <SwipeItems>
                                        <SwipeItem Text="XÃ³a" 
                                                   BackgroundColor="{StaticResource Error}"
                                                   Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.RemoveFromCartCommand}"
                                                   CommandParameter="{Binding .}"/>
                                    </SwipeItems>
                                </SwipeView.RightItems>
                                <Frame Margin="0,4" Padding="8" BorderColor="{StaticResource Gray200}">
                                    <Grid ColumnDefinitions="*,Auto,Auto">
                                        <VerticalStackLayout>
                                            <Label Text="{Binding ProductName}" 
                                                   FontAttributes="Bold"
                                                   LineBreakMode="TailTruncation"/>
                                            <Label Text="{Binding UnitPrice, StringFormat='{0:N0} â‚«'}"
                                                   FontSize="12"
                                                   TextColor="{StaticResource Gray500}"/>
                                        </VerticalStackLayout>
                                        
                                        <!-- Quantity Controls -->
                                        <HorizontalStackLayout Grid.Column="1" Spacing="4">
                                            <Button Text="-" 
                                                    WidthRequest="32" HeightRequest="32"
                                                    Padding="0"
                                                    BackgroundColor="{StaticResource Gray200}"
                                                    TextColor="{StaticResource Gray600}"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DecreaseQtyCommand}"
                                                    CommandParameter="{Binding .}"/>
                                            <Label Text="{Binding Qty}" 
                                                   VerticalTextAlignment="Center"
                                                   WidthRequest="30"
                                                   HorizontalTextAlignment="Center"/>
                                            <Button Text="+" 
                                                    WidthRequest="32" HeightRequest="32"
                                                    Padding="0"
                                                    BackgroundColor="{StaticResource Primary}"
                                                    TextColor="White"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.IncreaseQtyCommand}"
                                                    CommandParameter="{Binding .}"/>
                                        </HorizontalStackLayout>
                                        
                                        <Label Grid.Column="2"
                                               Text="{Binding LineTotal, StringFormat='{0:N0}'}"
                                               VerticalTextAlignment="Center"
                                               FontAttributes="Bold"
                                               WidthRequest="80"
                                               HorizontalTextAlignment="End"/>
                                    </Grid>
                                </Frame>
                            </SwipeView>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                    
                    <CollectionView.EmptyView>
                        <VerticalStackLayout VerticalOptions="Center" 
                                             HorizontalOptions="Center">
                            <Label Text="Giá» hÃ ng trá»‘ng" 
                                   TextColor="{StaticResource Gray400}"
                                   HorizontalTextAlignment="Center"/>
                            <Label Text="Cháº¡m vÃ o sáº£n pháº©m Ä‘á»ƒ thÃªm"
                                   FontSize="12"
                                   TextColor="{StaticResource Gray400}"
                                   HorizontalTextAlignment="Center"/>
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>
                </CollectionView>
                
                <!-- Totals -->
                <VerticalStackLayout Grid.Row="2" Spacing="4" Padding="0,8">
                    <BoxView HeightRequest="1" Color="{StaticResource Gray200}"/>
                    <Grid ColumnDefinitions="*,*" Padding="0,4">
                        <Label Text="Táº¡m tÃ­nh:" TextColor="{StaticResource Gray600}"/>
                        <Label Grid.Column="1" 
                               Text="{Binding Subtotal, StringFormat='{0:N0} â‚«'}"
                               HorizontalTextAlignment="End"/>
                    </Grid>
                    <Grid ColumnDefinitions="*,*">
                        <Label Text="Giáº£m giÃ¡:" TextColor="{StaticResource Gray600}"/>
                        <Label Grid.Column="1" 
                               Text="{Binding Discount, StringFormat='-{0:N0} â‚«'}"
                               HorizontalTextAlignment="End"
                               TextColor="{StaticResource Error}"/>
                    </Grid>
                    <Grid ColumnDefinitions="*,*">
                        <Label Text="VAT (10%):" TextColor="{StaticResource Gray600}"/>
                        <Label Grid.Column="1" 
                               Text="{Binding VATAmount, StringFormat='{0:N0} â‚«'}"
                               HorizontalTextAlignment="End"/>
                    </Grid>
                    <BoxView HeightRequest="1" Color="{StaticResource Gray300}"/>
                    <Grid ColumnDefinitions="*,*" Padding="0,4">
                        <Label Text="Tá»•ng cá»™ng:" 
                               FontAttributes="Bold" 
                               FontSize="16"/>
                        <Label Grid.Column="1" 
                               Text="{Binding Total, StringFormat='{0:N0} â‚«'}"
                               HorizontalTextAlignment="End"
                               FontAttributes="Bold"
                               FontSize="18"
                               TextColor="{StaticResource Primary}"/>
                    </Grid>
                </VerticalStackLayout>
                
                <!-- Pending Invoice Actions -->
                <Grid Grid.Row="3" ColumnDefinitions="*,*,*" ColumnSpacing="4" Margin="0,8,0,0">
                    <Button Grid.Column="0"
                            Text="â³ LÆ°u chá»"
                            Command="{Binding SavePendingCommand}"
                            BackgroundColor="#FFC107"
                            TextColor="Black"
                            FontAttributes="Bold"
                            FontSize="12"/>
                    <Button Grid.Column="1"
                            Text="ðŸ“‹ Láº¥y láº¡i HÄ"
                            Command="{Binding RetrievePendingCommand}"
                            BackgroundColor="#17A2B8"
                            TextColor="White"
                            FontAttributes="Bold"
                            FontSize="12"/>
                    <Button Grid.Column="2"
                            Text="ðŸš« Huá»· HÄ chá»"
                            Command="{Binding CancelPendingCommand}"
                            BackgroundColor="#DC3545"
                            TextColor="White"
                            FontAttributes="Bold"
                            FontSize="12"/>
                </Grid>

                <!-- Action Buttons -->
                <Grid Grid.Row="4" ColumnDefinitions="*,*" ColumnSpacing="8" Margin="0,8,0,0">
                    <Button Grid.Column="0"
                            Text="ðŸ—‘ï¸ Há»§y"
                            Command="{Binding ClearCartCommand}"
                            Style="{StaticResource SecondaryButton}"/>
                    <Button Grid.Column="1"
                            Text="ðŸ’³ Thanh toÃ¡n"
                            Command="{Binding CheckoutCommand}"
                            Style="{StaticResource PrimaryButton}"/>
                </Grid>
            </Grid>
        </Frame>

        <!-- Bottom: Recent Invoices Toggle (REMOVED) -->
        <!-- 
        <Frame Grid.Row="2" Grid.ColumnSpan="2" 
               Padding="12" Margin="8"
               Style="{StaticResource Card}">
            <Grid ColumnDefinitions="*,Auto">
                <Label Text="{Binding Invoices.Count, StringFormat='ðŸ“‹ {0} hÃ³a Ä‘Æ¡n hÃ´m nay'}"
                       VerticalTextAlignment="Center"/>
                <Button Grid.Column="1"
                        Text="Xem táº¥t cáº£"
                        Command="{Binding ViewAllInvoicesCommand}"
                        BackgroundColor="Transparent"
                        TextColor="{StaticResource Primary}"/>
            </Grid>
        </Frame> 
        -->
        
        <!-- Loading Overlay -->
        <Grid Grid.RowSpan="3" Grid.ColumnSpan="2"
              IsVisible="{Binding IsLoading}"
              BackgroundColor="#80000000">
            <ActivityIndicator IsRunning="True" 
                               Color="White"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"/>
        </Grid>
    </Grid>

</ContentPage>
